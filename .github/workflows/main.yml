name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Emacs 30
        uses: purcell/setup-emacs@v0.3
        with:
          emacs-version: snapshot
          install-just-the-emacs: true

      - name: Show Emacs version
        run: |
          emacs --version

      - name: Run tests with Emacs 30
        run: |
          emacs --batch -l ert \
            -eval "(setq load-path (append '(\"test\") load-path))" \
            -l init.el \
            -eval "(require 'my-helpers nil t)" \
            -eval "(require 'my-config-test nil t)" \
            -f ert-run-tests-batch-and-exit

      - name: Compile init.el
        run: |
          emacs --batch \
            -l early-init.el -l init.el \
            --eval "(byte-compile-file \"init.el\")"
